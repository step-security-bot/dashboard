import{j as p}from"./jsx-runtime-QvtbNqby.js";import{r as R}from"./index-BjzEU6Zr.js";import{P as st}from"./usePrefix-CXWdRn9x.js";import{B as W}from"./Button-xjCpe_BM.js";import{S as lt}from"./SkeletonText-pbC4hZL_.js";import{_ as at}from"./extends-CF3RwP-h.js";import{_ as ct,a as D}from"./inheritsLoose-CMy1E8oj.js";import{i as ut}from"./index-yfVukVkJ.js";import{a as dt,i as mt}from"./index-CfoIBI3E.js";import{d as ht}from"./bucket-17-BNnKjYXl.js";import{a as pt}from"./bucket-5-BULz4hzg.js";import{L as Q}from"./LogFormat-DErnYbCT.js";import{S as ft}from"./DotSpinner-BSho4s4W.js";var H=Number.isNaN||function(t){return typeof t=="number"&&t!==t};function gt(n,t){return!!(n===t||H(n)&&H(t))}function St(n,t){if(n.length!==t.length)return!1;for(var o=0;o<n.length;o++)if(!gt(n[o],t[o]))return!1;return!0}function B(n,t){t===void 0&&(t=St);var o,l=[],s,d=!1;function S(){for(var h=[],y=0;y<arguments.length;y++)h[y]=arguments[y];return d&&o===this&&t(h,l)||(s=n.apply(this,h),d=!0,o=this,l=h),s}return S}var vt=typeof performance=="object"&&typeof performance.now=="function",$=vt?function(){return performance.now()}:function(){return Date.now()};function q(n){cancelAnimationFrame(n.id)}function yt(n,t){var o=$();function l(){$()-o>=t?n.call(null):s.id=requestAnimationFrame(l)}var s={id:requestAnimationFrame(l)};return s}var U=-1;function V(n){if(n===void 0&&(n=!1),U===-1||n){var t=document.createElement("div"),o=t.style;o.width="50px",o.height="50px",o.overflow="scroll",document.body.appendChild(t),U=t.offsetWidth-t.clientWidth,document.body.removeChild(t)}return U}var w=null;function K(n){if(n===void 0&&(n=!1),w===null||n){var t=document.createElement("div"),o=t.style;o.width="50px",o.height="50px",o.overflow="scroll",o.direction="rtl";var l=document.createElement("div"),s=l.style;return s.width="100px",s.height="100px",t.appendChild(l),document.body.appendChild(t),t.scrollLeft>0?w="positive-descending":(t.scrollLeft=1,t.scrollLeft===0?w="negative":w="positive-ascending"),document.body.removeChild(t),w}return w}var Tt=150,It=function(t,o){return t};function Lt(n){var t,o=n.getItemOffset,l=n.getEstimatedTotalSize,s=n.getItemSize,d=n.getOffsetForIndexAndAlignment,S=n.getStartIndexForOffset,h=n.getStopIndexForStartIndex,y=n.initInstanceProps,I=n.shouldResetStyleCacheOnItemSizeChange,x=n.validateProps;return t=function(M){ct(C,M);function C(v){var e;return e=M.call(this,v)||this,e._instanceProps=y(e.props,D(e)),e._outerRef=void 0,e._resetIsScrollingTimeoutId=null,e.state={instance:D(e),isScrolling:!1,scrollDirection:"forward",scrollOffset:typeof e.props.initialScrollOffset=="number"?e.props.initialScrollOffset:0,scrollUpdateWasRequested:!1},e._callOnItemsRendered=void 0,e._callOnItemsRendered=B(function(r,i,a,u){return e.props.onItemsRendered({overscanStartIndex:r,overscanStopIndex:i,visibleStartIndex:a,visibleStopIndex:u})}),e._callOnScroll=void 0,e._callOnScroll=B(function(r,i,a){return e.props.onScroll({scrollDirection:r,scrollOffset:i,scrollUpdateWasRequested:a})}),e._getItemStyle=void 0,e._getItemStyle=function(r){var i=e.props,a=i.direction,u=i.itemSize,f=i.layout,c=e._getItemStyleCache(I&&u,I&&f,I&&a),m;if(c.hasOwnProperty(r))m=c[r];else{var g=o(e.props,r,e._instanceProps),L=s(e.props,r,e._instanceProps),b=a==="horizontal"||f==="horizontal",k=a==="rtl",P=b?g:0;c[r]=m={position:"absolute",left:k?void 0:P,right:k?P:void 0,top:b?0:g,height:b?"100%":L,width:b?L:"100%"}}return m},e._getItemStyleCache=void 0,e._getItemStyleCache=B(function(r,i,a){return{}}),e._onScrollHorizontal=function(r){var i=r.currentTarget,a=i.clientWidth,u=i.scrollLeft,f=i.scrollWidth;e.setState(function(c){if(c.scrollOffset===u)return null;var m=e.props.direction,g=u;if(m==="rtl")switch(K()){case"negative":g=-u;break;case"positive-descending":g=f-a-u;break}return g=Math.max(0,Math.min(g,f-a)),{isScrolling:!0,scrollDirection:c.scrollOffset<g?"forward":"backward",scrollOffset:g,scrollUpdateWasRequested:!1}},e._resetIsScrollingDebounced)},e._onScrollVertical=function(r){var i=r.currentTarget,a=i.clientHeight,u=i.scrollHeight,f=i.scrollTop;e.setState(function(c){if(c.scrollOffset===f)return null;var m=Math.max(0,Math.min(f,u-a));return{isScrolling:!0,scrollDirection:c.scrollOffset<m?"forward":"backward",scrollOffset:m,scrollUpdateWasRequested:!1}},e._resetIsScrollingDebounced)},e._outerRefSetter=function(r){var i=e.props.outerRef;e._outerRef=r,typeof i=="function"?i(r):i!=null&&typeof i=="object"&&i.hasOwnProperty("current")&&(i.current=r)},e._resetIsScrollingDebounced=function(){e._resetIsScrollingTimeoutId!==null&&q(e._resetIsScrollingTimeoutId),e._resetIsScrollingTimeoutId=yt(e._resetIsScrolling,Tt)},e._resetIsScrolling=function(){e._resetIsScrollingTimeoutId=null,e.setState({isScrolling:!1},function(){e._getItemStyleCache(-1,null)})},e}C.getDerivedStateFromProps=function(e,r){return bt(e,r),x(e),null};var T=C.prototype;return T.scrollTo=function(e){e=Math.max(0,e),this.setState(function(r){return r.scrollOffset===e?null:{scrollDirection:r.scrollOffset<e?"forward":"backward",scrollOffset:e,scrollUpdateWasRequested:!0}},this._resetIsScrollingDebounced)},T.scrollToItem=function(e,r){r===void 0&&(r="auto");var i=this.props,a=i.itemCount,u=i.layout,f=this.state.scrollOffset;e=Math.max(0,Math.min(e,a-1));var c=0;if(this._outerRef){var m=this._outerRef;u==="vertical"?c=m.scrollWidth>m.clientWidth?V():0:c=m.scrollHeight>m.clientHeight?V():0}this.scrollTo(d(this.props,e,r,f,this._instanceProps,c))},T.componentDidMount=function(){var e=this.props,r=e.direction,i=e.initialScrollOffset,a=e.layout;if(typeof i=="number"&&this._outerRef!=null){var u=this._outerRef;r==="horizontal"||a==="horizontal"?u.scrollLeft=i:u.scrollTop=i}this._callPropsCallbacks()},T.componentDidUpdate=function(){var e=this.props,r=e.direction,i=e.layout,a=this.state,u=a.scrollOffset,f=a.scrollUpdateWasRequested;if(f&&this._outerRef!=null){var c=this._outerRef;if(r==="horizontal"||i==="horizontal")if(r==="rtl")switch(K()){case"negative":c.scrollLeft=-u;break;case"positive-ascending":c.scrollLeft=u;break;default:var m=c.clientWidth,g=c.scrollWidth;c.scrollLeft=g-m-u;break}else c.scrollLeft=u;else c.scrollTop=u}this._callPropsCallbacks()},T.componentWillUnmount=function(){this._resetIsScrollingTimeoutId!==null&&q(this._resetIsScrollingTimeoutId)},T.render=function(){var e=this.props,r=e.children,i=e.className,a=e.direction,u=e.height,f=e.innerRef,c=e.innerElementType,m=e.innerTagName,g=e.itemCount,L=e.itemData,b=e.itemKey,k=b===void 0?It:b,P=e.layout,Y=e.outerElementType,Z=e.outerTagName,tt=e.style,et=e.useIsScrolling,ot=e.width,N=this.state.isScrolling,O=a==="horizontal"||P==="horizontal",nt=O?this._onScrollHorizontal:this._onScrollVertical,A=this._getRangeToRender(),rt=A[0],it=A[1],F=[];if(g>0)for(var z=rt;z<=it;z++)F.push(R.createElement(r,{data:L,key:k(z,L),index:z,isScrolling:et?N:void 0,style:this._getItemStyle(z)}));var j=l(this.props,this._instanceProps);return R.createElement(Y||Z||"div",{className:i,onScroll:nt,ref:this._outerRefSetter,style:at({position:"relative",height:u,width:ot,overflow:"auto",WebkitOverflowScrolling:"touch",willChange:"transform",direction:a},tt)},R.createElement(c||m||"div",{children:F,ref:f,style:{height:O?"100%":j,pointerEvents:N?"none":void 0,width:O?j:"100%"}}))},T._callPropsCallbacks=function(){if(typeof this.props.onItemsRendered=="function"){var e=this.props.itemCount;if(e>0){var r=this._getRangeToRender(),i=r[0],a=r[1],u=r[2],f=r[3];this._callOnItemsRendered(i,a,u,f)}}if(typeof this.props.onScroll=="function"){var c=this.state,m=c.scrollDirection,g=c.scrollOffset,L=c.scrollUpdateWasRequested;this._callOnScroll(m,g,L)}},T._getRangeToRender=function(){var e=this.props,r=e.itemCount,i=e.overscanCount,a=this.state,u=a.isScrolling,f=a.scrollDirection,c=a.scrollOffset;if(r===0)return[0,0,0,0];var m=S(this.props,c,this._instanceProps),g=h(this.props,m,c,this._instanceProps),L=!u||f==="backward"?Math.max(1,i):1,b=!u||f==="forward"?Math.max(1,i):1;return[Math.max(0,m-L),Math.max(0,Math.min(r-1,g+b)),m,g]},C}(R.PureComponent),t.defaultProps={direction:"ltr",itemData:void 0,layout:"vertical",overscanCount:2,useIsScrolling:!1},t}var bt=function(t,o){t.children,t.direction,t.height,t.layout,t.innerTagName,t.outerTagName,t.width,o.instance},xt=Lt({getItemOffset:function(t,o){var l=t.itemSize;return o*l},getItemSize:function(t,o){var l=t.itemSize;return l},getEstimatedTotalSize:function(t){var o=t.itemCount,l=t.itemSize;return l*o},getOffsetForIndexAndAlignment:function(t,o,l,s,d,S){var h=t.direction,y=t.height,I=t.itemCount,x=t.itemSize,M=t.layout,C=t.width,T=h==="horizontal"||M==="horizontal",v=T?C:y,e=Math.max(0,I*x-v),r=Math.min(e,o*x),i=Math.max(0,o*x-v+x+S);switch(l==="smart"&&(s>=i-v&&s<=r+v?l="auto":l="center"),l){case"start":return r;case"end":return i;case"center":{var a=Math.round(i+(r-i)/2);return a<Math.ceil(v/2)?0:a>e+Math.floor(v/2)?e:a}case"auto":default:return s>=i&&s<=r?s:s<i?i:r}},getStartIndexForOffset:function(t,o){var l=t.itemCount,s=t.itemSize;return Math.max(0,Math.min(l-1,Math.floor(o/s)))},getStopIndexForStartIndex:function(t,o,l){var s=t.direction,d=t.height,S=t.itemCount,h=t.itemSize,y=t.layout,I=t.width,x=s==="horizontal"||y==="horizontal",M=o*h,C=x?I:d,T=Math.ceil((C+l-M)/h);return Math.max(0,Math.min(S-1,o+T-1))},initInstanceProps:function(t){},shouldResetStyleCacheOnItemSizeChange:!0,validateProps:function(t){t.itemSize}});const Ct=/(auto|scroll)/;function G(n,t){return n&&window.getComputedStyle(n,null).getPropertyValue(t)}function X(n){return n&&Ct.test(G(n,"overflow")+G(n,"overflow-y"))}function Rt(n){return X(n)&&n.scrollHeight-n.clientHeight>n.scrollTop}function Mt(n){return X(n)&&n.scrollTop>0}function wt(n){return Math.round(n?.getBoundingClientRect().top)<0}function zt(n){return Math.round(n?.getBoundingClientRect().bottom)>document.documentElement?.clientHeight}const kt=({data:n,index:t,style:o})=>p.jsx("div",{style:o,children:p.jsx(Q,{children:`${n[t]}
`})}),E=15,J=E*100+E/2;class _ extends R.Component{constructor(t){super(t),this.state={loading:!0},this.logRef=R.createRef(),this.textRef=R.createRef()}componentDidMount(){this.loadLog(),(this.props.enableLogAutoScroll||this.props.enableLogScrollButtons)&&(this.wasRunningAfterMounting(),window.addEventListener("scroll",this.handleLogScroll,!0),this.handleLogScroll())}componentDidUpdate(t,o){if((this.props.enableLogAutoScroll||this.props.enableLogScrollButtons)&&(o.logs?.length!==this.state.logs?.length||t.isLogsMaximized!==this.props.isLogsMaximized)){if(this.shouldAutoScroll()){this.scrollToBottomLog();return}this.handleLogScroll()}}componentWillUnmount(){window.removeEventListener("scroll",this.handleLogScroll,!0),clearTimeout(this.timer),this.cancelled=!0}handleLogScroll=()=>{if(!this.state.loading){const t=this.isLogBottomUnseen(),o=this.props.enableLogScrollButtons&&this.isLogTopUnseen();this.updateScrollButtonCoordinates(),(t!==this.state.isLogBottomUnseen||this.props.enableLogScrollButtons&&o!==this.state.isLogTopUnseen)&&this.setState({isLogBottomUnseen:t,isLogTopUnseen:o})}};shouldAutoScroll=()=>this.props.enableLogAutoScroll&&this.state.isLogBottomUnseen===!1&&this.wasRunningAfterMounting()&&this.isLogBottomUnseen();isLogBottomUnseen=()=>zt(this.logRef?.current)||Rt(this.textRef?.current?.firstElementChild);isLogTopUnseen=()=>wt(this.logRef?.current)||Mt(this.textRef?.current?.firstElementChild);scrollToBottomLog=()=>{const t=this.textRef?.current?.firstElementChild;t&&(t.scrollTop=t.scrollHeight-t.clientHeight);const o=document.documentElement;o.scrollTop=o.scrollHeight-o.clientHeight};scrollToTopLog=()=>{const t=this.textRef?.current?.firstElementChild;t&&(t.scrollTop=0),document.documentElement.scrollTop=0};wasRunningAfterMounting=()=>{if(this.alreadyWasRunningAfterMounting)return!0;const{reason:t,status:o}=dt(this.props.stepStatus);return mt(t,o)?(this.alreadyWasRunningAfterMounting=!0,!0):!1};updateScrollButtonCoordinates=()=>{if(this.props.enableLogScrollButtons){const t=this.logRef.current?.getBoundingClientRect(),o=document.documentElement.clientWidth-t.right,l=Math.max(0,t.top),s=Math.max(0,document.documentElement.clientHeight-t.bottom);this.updateCssStyleProperty(o,"--tkn-log-element-right"),this.updateCssStyleProperty(l,"--tkn-scroll-button-top"),this.updateCssStyleProperty(s,"--tkn-scroll-button-bottom")}};updateCssStyleProperty=(t,o)=>{!Number.isNaN(t)&&this[o]!==t&&(this[o]=t,document.documentElement.style.setProperty(o,`${t.toString()}px`))};getScrollButtons=()=>{const t=this.context,{enableLogScrollButtons:o,intl:l}=this.props,{isLogBottomUnseen:s,isLogTopUnseen:d,loading:S}=this.state;if(!o||S)return null;const h=l.formatMessage({id:"dashboard.logs.scrollToTop",defaultMessage:"Scroll to start of logs"}),y=l.formatMessage({id:"dashboard.logs.scrollToBottom",defaultMessage:"Scroll to end of logs"});return p.jsxs("div",{className:"button-container",children:[d?p.jsx(W,{className:`${t}--copy-btn`,hasIconOnly:!0,iconDescription:h,id:"log-scroll-to-start-btn",onClick:this.scrollToTopLog,renderIcon:()=>p.jsx(ht,{children:p.jsx("title",{children:h})}),size:"sm",tooltipPosition:"right"}):null,s?p.jsx(W,{className:`${t}--copy-btn`,iconDescription:y,hasIconOnly:!0,id:"log-scroll-to-end-btn",onClick:this.scrollToBottomLog,renderIcon:()=>p.jsx(pt,{children:p.jsx("title",{children:y})}),size:"sm",tooltipPosition:"right"}):null]})};getLogList=()=>{const{stepStatus:t,intl:o}=this.props,{reason:l}=t&&t.terminated||{},{logs:s=[o.formatMessage({id:"dashboard.pipelineRun.logEmpty",defaultMessage:"No log available"})]}=this.state;if(s.length<2e4)return p.jsx(Q,{children:s.join(`
`)});const d=l?Math.min(J,E*s.length):J;return p.jsx(xt,{height:d,itemCount:s.length,itemData:s,itemSize:E,width:"100%",children:kt})};getTrailerMessage=({exitCode:t,reason:o,terminationReason:l})=>{const{forcePolling:s,intl:d}=this.props;if(l==="Skipped")return d.formatMessage({id:"dashboard.pipelineRun.stepSkipped",defaultMessage:"Step skipped"});if(o&&s)return p.jsxs(p.Fragment,{children:[d.formatMessage({id:"dashboard.logs.pending",defaultMessage:"Final logs pending"}),p.jsx(ft,{})]});switch(o){case"Completed":return t!==0?d.formatMessage({id:"dashboard.pipelineRun.stepCompleted.exitCode",defaultMessage:"Step completed with exit code {exitCode}"},{exitCode:t}):d.formatMessage({id:"dashboard.pipelineRun.stepCompleted",defaultMessage:"Step completed successfully"});case"Error":return d.formatMessage({id:"dashboard.pipelineRun.stepFailed",defaultMessage:"Step failed"});default:return null}};readChunks=({done:t,value:o},l,s="")=>{if(this.cancelled){this.reader.cancel();return}let d=s;if(o?(d+=l.decode(o,{stream:!t}),this.setState({loading:!1,logs:d.split(`
`)})):this.setState({loading:!1}),!t)return this.reader.read().then(S=>this.readChunks(S,l,d)).catch(S=>(console.error(S),this.loadLog()))};loadLog=async()=>{const{fetchLogs:t,forcePolling:o,intl:l,stepStatus:s,pollingInterval:d}=this.props;if(!t)return;let S=!1;try{S=o||s&&!s.terminated;const h=await t();if(h?.getReader){const y=new TextDecoder;this.reader=h.getReader(),await this.reader.read().then(I=>this.readChunks(I,y)).catch(I=>{throw I})}else this.setState({loading:!1,logs:h?h.split(`
`):void 0}),S&&(clearTimeout(this.timer),this.timer=setTimeout(this.loadLog,d))}catch(h){console.error(h),this.setState({loading:!1,logs:[l.formatMessage({id:"dashboard.pipelineRun.logFailed",defaultMessage:"Unable to fetch log"})]}),S&&(clearTimeout(this.timer),this.timer=setTimeout(this.loadLog,d))}};logTrailer=()=>{const{forcePolling:t,stepStatus:o}=this.props,{exitCode:l,reason:s}=o&&o.terminated||{},d=this.getTrailerMessage({exitCode:l,reason:s,terminationReason:o?.terminationReason});return d?p.jsx("div",{className:"tkn--log-trailer","data-status":s&&(t?"LogsPending":s),children:d}):null};render(){const{toolbar:t}=this.props,{loading:o}=this.state;return p.jsx("pre",{className:"tkn--log tkn--theme-dark",ref:this.logRef,children:o?p.jsx(lt,{paragraph:!0,width:"60%"}):p.jsxs(p.Fragment,{children:[t,p.jsx("div",{className:"tkn--log-container",ref:this.textRef,children:this.getLogList()}),this.logTrailer(),this.getScrollButtons()]})})}}_.contextType=st;_.defaultProps={pollingInterval:4e3};const $t=ut(_);_.__docgenInfo={description:"",methods:[{name:"handleLogScroll",docblock:null,modifiers:[],params:[],returns:null},{name:"shouldAutoScroll",docblock:null,modifiers:[],params:[],returns:null},{name:"isLogBottomUnseen",docblock:null,modifiers:[],params:[],returns:null},{name:"isLogTopUnseen",docblock:null,modifiers:[],params:[],returns:null},{name:"scrollToBottomLog",docblock:null,modifiers:[],params:[],returns:null},{name:"scrollToTopLog",docblock:null,modifiers:[],params:[],returns:null},{name:"wasRunningAfterMounting",docblock:null,modifiers:[],params:[],returns:null},{name:"updateScrollButtonCoordinates",docblock:null,modifiers:[],params:[],returns:null},{name:"updateCssStyleProperty",docblock:null,modifiers:[],params:[{name:"computedVariable",optional:!1,type:null},{name:"variableName",optional:!1,type:null}],returns:null},{name:"getScrollButtons",docblock:null,modifiers:[],params:[],returns:null},{name:"getLogList",docblock:null,modifiers:[],params:[],returns:null},{name:"getTrailerMessage",docblock:null,modifiers:[],params:[{name:"{ exitCode, reason, terminationReason }",optional:!1,type:null}],returns:null},{name:"readChunks",docblock:null,modifiers:[],params:[{name:"{ done, value }",optional:!1,type:null},{name:"decoder",optional:!1,type:null},{name:"text",optional:!0,type:null}],returns:null},{name:"loadLog",docblock:null,modifiers:["async"],params:[],returns:null},{name:"logTrailer",docblock:null,modifiers:[],params:[],returns:null}],displayName:"LogContainer",props:{pollingInterval:{defaultValue:{value:"4000",computed:!1},required:!1}}};export{$t as L};
